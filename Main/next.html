<!DOCTYPE html>
<html>
<head>
    <title>Placeholder Title V2</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="css/next.css">
</head>
<body>
    <button type="button" id="back">‚Üê Go Back</button>
    <div id="resultsTable">
        <h2>Recommended Route</h2>
        <p id="API-info">Loading...</p>
    </div>

    <button id="generateNFTButton" onclick="window.location.href='pre-certificate.html'">Get your certificate!</button>
    
    <p id="nftStatus"></p>
    <img id="nftImage" alt="NFT Image" style="display: none;"/>

    <script src="js/animation.js"></script>
    <script>
        async function sendPostRequest() {
            try {
                const topics = JSON.parse(localStorage.getItem('topics')) || [];
                const main_topic = localStorage.getItem('main_topic') || '';
                const data = { topics: topics, main_topic: main_topic };

                const response = await fetch("http://localhost:8000/generate_study_plan", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    const studyPlan = await response.json();
                    document.getElementById("API-info").innerHTML = studyPlan.study_plan.replace(/\n/g, '<br>');
                } else {
                    console.error(`Error: ${response.status}`);
                    document.getElementById("API-info").innerHTML = "Failed to load study plan.";
                }
            } catch (error) {
                console.error(`An error occurred: ${error}`);
                document.getElementById("API-info").innerHTML = "An error occurred while loading the study plan.";
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            sendPostRequest();

            const generateNFTButton = document.getElementById('generateNFTButton');
            const backButton = document.getElementById('back');
            
            if (generateNFTButton) {
                generateNFTButton.addEventListener('click', async function() {
                    const endpointUrl = 'http://localhost:8080/get_nft_and_image';
                    try {
                        const response = await fetch(endpointUrl);
                        if (response.ok) {
                            const data = await response.json();
                            localStorage.setItem('nftData', JSON.stringify(data));
                            window.location.href = 'certification.html';
                        } else {
                            console.error('Failed to retrieve NFT. Status code: ' + response.status);
                            alert('Failed to retrieve NFT. Please try again.');
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        alert('An error occurred. Please try again.');
                    }
                });
            } else {
                console.error('Generate NFT button not found');
            }

            if (backButton) {
                backButton.addEventListener('click', function() {
                    window.location.href = 'main.html';
                });
            } else {
                console.error('Back button not found');
            }
        });
    </script>
</body>
</html>